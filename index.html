<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Spades - 7 Point Game</title>
<style>
  body { margin:0; font-family:Arial,sans-serif; background:#0d1b2a; color:#e0e1dd; height:100vh; display:flex; flex-direction:column; }
  button { font-size:18px; padding:12px 16px; margin:8px; border:none; border-radius:8px; background:#1b263b; color:#e0e1dd; min-height:56px; }
  button:active { background:#415a77; }
  input[type=number] { font-size:20px; padding:10px; width:80px; text-align:center; border-radius:8px; background:#1b263b; color:#e0e1dd; }
  .container { flex:1; display:flex; flex-direction:column; padding:10px; gap:10px; overflow:auto; }
  .info { text-align:center; font-size:18px; padding:10px; background:#1b263b; border-radius:8px; }
  .bids { display:flex; justify-content:space-around; padding:10px; background:#1b263b; border-radius:8px; font-size:16px; }
  .bid-item { text-align:center; }
  .bid-item strong { font-size:20px; color:#778da9; }
  .trick { display:flex; justify-content:center; gap:20px; flex-wrap:wrap; min-height:100px; }
  .hand { display:flex; flex-wrap:wrap; justify-content:center; gap:8px; padding:10px; background:#1b263b; border-radius:8px; }
  .card {
    width:56px; height:80px; background:#fff; color:#000; border-radius:8px; box-shadow:0 3px 8px rgba(0,0,0,0.7);
    display:flex; flex-direction:column; justify-content:center; align-items:center; font-weight:bold; font-size:14px;
    touch-action:manipulation;
  }
  .card.spades, .card.clubs { color:#000; }
  .card.hearts, .card.diamonds { color:#c33; }
  .card.playable { box-shadow:0 0 12px #0f0; transform:scale(1.08); }
  .card.playable:active { transform:scale(0.95); }
  .player-label { font-size:14px; margin-top:4px; color:#778da9; }
  .score { text-align:center; font-size:22px; padding:15px; background:#1b263b; border-radius:8px; }
  .winner { font-size:32px; color:#ff0; text-align:center; padding:30px; }
  .alert { text-align:center; font-size:20px; color:#ff6; background:#411; padding:20px; border-radius:8px; margin:10px; }
</style>
</head>
<body>

<div class="container" id="game"></div>

<script>
const suits = ['♠','♥','♦','♣'];
const ranks = ['A','K','Q','J','10','9','8','7','6','5','4','3','2'];
const suitNames = {'♠':'spades','♥':'hearts','♦':'diamonds','♣':'clubs'};
const players = ['A','B','C','D']; // A=Human, B=Comp, C=Comp Partner, D=Comp

let deck = [];
let hands = {A:[], B:[], C:[], D:[]};
let bids = {A:0, B:0, C:0, D:0};
let currentBidder = 'A';
let totalBid = 0;
let tricksWon = {A:0, B:0, C:0, D:0};
let currentTrick = [];
let leadSuit = null;
let spadesBroken = false;
let turn = null;
let teamScore = {us:0, them:0}; // us = A+C, them = B+D
let handNumber = 0;
let gameOver = false;

function createDeck() {
  deck = [];
  for (let s of suits) for (let r of ranks) {
    deck.push({suit:s, rank:r, value:ranks.indexOf(r)+2});
  }
  shuffle(deck);
}

function shuffle(a) {
  for (let i = a.length-1; i > 0; i--) {
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
}

function deal() {
  createDeck();
  hands = {A:[], B:[], C:[], D:[]};
  for (let i=0; i<52; i++) {
    hands[players[i%4]].push(deck[i]);
  }
  for (let p in hands) {
    hands[p].sort((a,b) => {
      if (a.suit !== b.suit) return suits.indexOf(a.suit) - suits.indexOf(b.suit);
      return b.value - a.value;
    });
  }
}

function renderCard(card, playable=false) {
  const div = document.createElement('div');
  div.className = 'card ' + suitNames[card.suit] + (playable ? ' playable' : '');
  div.innerHTML = card.rank + '<br>' + card.suit;
  if (playable) div.onclick = () => playCard(card);
  return div;
}

function renderGame() {
  const container = document.getElementById('game');
  container.innerHTML = '';

  if (gameOver) {
    container.innerHTML = `<div class="winner">${teamScore.us >= 7 ? 'You and Partner Win!' : 'Opponents Win!'}</div>
                           <button onclick="newGame()">New Game</button>`;
    return;
  }

  // Score
  const scoreDiv = document.createElement('div');
  scoreDiv.className = 'score';
  scoreDiv.innerHTML = `Score — You & Partner: <strong>${teamScore.us}</strong>  Opponents: <strong>${teamScore.them}</strong>`;
  container.appendChild(scoreDiv);

  // Current bids
  const bidsDiv = document.createElement('div');
  bidsDiv.className = 'bids';
  bidsDiv.innerHTML = `
    <div class="bid-item">You<br><strong>${bids.A ?? '-'}</strong></div>
    <div class="bid-item">Opp B<br><strong>${bids.B ?? '-'}</strong></div>
    <div class="bid-item">Partner<br><strong>${bids.C ?? '-'}</strong></div>
    <div class="bid-item">Opp D<br><strong>${bids.D ?? '-'}</strong></div>
  `;
  container.appendChild(bidsDiv);

  // Bidding phase
  if (currentBidder && totalBid < 13) {
    const info = document.createElement('div');
    info.className = 'info';
    if (currentBidder === 'A') {
      info.innerHTML = `Your bid (0-13):`;
      const input = document.createElement('input');
      input.type = 'number'; input.min = 0; input.max = 13; input.value = 3;
      input.id = 'humanBid';
      const btn = document.createElement('button');
      btn.textContent = 'Submit Bid';
      btn.onclick = submitHumanBid;
      info.appendChild(input);
      info.appendChild(document.createElement('br'));
      info.appendChild(btn);
    } else {
      info.textContent = `Player ${currentBidder} is bidding...`;
      setTimeout(computerBid, 800);
    }
    container.appendChild(info);
    return;
  }

  // Show any alert (card shift)
  if (window.lastAlert) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert';
    alertDiv.textContent = window.lastAlert;
    container.appendChild(alertDiv);
    delete window.lastAlert;
    setTimeout(() => renderGame(), 3000);
    return;
  }

  // Play phase
  const info = document.createElement('div');
  info.className = 'info';
  info.textContent = turn ? `Turn: Player ${turn}` : 'Starting play...';
  container.appendChild(info);

  // Current trick
  const trickDiv = document.createElement('div');
  trickDiv.className = 'trick';
  currentTrick.forEach(t => {
    const wrapper = document.createElement('div');
    wrapper.style.textAlign = 'center';
    wrapper.appendChild(renderCard(t.card));
    const label = document.createElement('div');
    label.className = 'player-label';
    label.textContent = t.player;
    wrapper.appendChild(label);
    trickDiv.appendChild(wrapper);
  });
  container.appendChild(trickDiv);

  // Human hand
  const handDiv = document.createElement('div');
  handDiv.className = 'hand';
  const legal = legalCards('A');
  hands.A.forEach(c => handDiv.appendChild(renderCard(c, legal.includes(c))));
  container.appendChild(handDiv);

  if (turn && turn !== 'A') setTimeout(computerPlay, 900);
}

function submitHumanBid() {
  const val = parseInt(document.getElementById('humanBid').value);
  if (isNaN(val) || val < 0 || val > 13) return alert('Bid 0–13');
  placeBid('A', val);
}

function placeBid(player, bid) {
  bids[player] = bid;
  totalBid += bid;
  currentBidder = players[(players.indexOf(player) + 1) % 4];
  if (totalBid < 13) {
    renderGame();
  } else {
    checkTotalBid();
  }
}

function computerBid() {
  const player = currentBidder;
  const hand = hands[player];
  let estimate = 0;

  // Simple heuristic
  const suitCount = {'♠':0,'♥':0,'♦':0,'♣':0};
  hand.forEach(c => suitCount[c.suit]++);

  hand.forEach(c => {
    if (c.suit === '♠') {
      if (c.rank === 'A') estimate += 1.2;
      else if (c.rank === 'K') estimate += 1.0;
      else if (['Q','J','10'].includes(c.rank)) estimate += 0.7;
      else estimate += 0.3;
    } else {
      if (c.rank === 'A') estimate += 1.0;
      else if (c.rank === 'K' && suitCount[c.suit] >= 2) estimate += 0.6;
      else if (c.rank === 'Q' && suitCount[c.suit] >= 3) estimate += 0.4;
    }
  });

  // Voids & singletons
  for (let s in suitCount) {
    if (suitCount[s] === 0) estimate += 0.8;
    if (suitCount[s] === 1) estimate += 0.4;
  }

  let bid = Math.round(estimate);
  bid = Math.max(0, Math.min(13 - totalBid, bid)); // can't go over
  if (totalBid + bid > 13) bid = 13 - totalBid;

  placeBid(player, bid);
}

function checkTotalBid() {
  if (totalBid === 13) {
    startPlay();
  } else {
    // Card shift rule
    const shiftingTeam = totalBid < 13 ? 'them' : 'us'; // rough guess; actually whoever wants to force
    const increaseTeam = shiftingTeam === 'us' ? 'us' : 'them';

    // Shift cards right: A→B, B→C, C→D, D→A
    const temp = {...hands};
    hands.B = temp.A; hands.C = temp.B; hands.D = temp.C; hands.A = temp.D;

    // Increase team bid by 1
    if (increaseTeam === 'us') {
      bids.A += 1;
    } else {
      bids.B += 1;
    }
    totalBid += 1;

    window.lastAlert = `Bids did not total 13. Cards shifted. ${increaseTeam === 'us' ? 'Your' : 'Opponent'} team bid increased by 1.`;
    renderGame();
  }
}

function startPlay() {
  currentTrick = [];
  turn = 'A';
  spadesBroken = false;
  renderGame();
}

function legalCards(player) {
  const hand = hands[player];
  if (currentTrick.length === 0) {
    // Leading
    if (!spadesBroken && hand.some(c => c.suit === '♠')) {
      return hand.filter(c => c.suit !== '♠');
    }
    return hand;
  }
  const lead = leadSuit;
  const inSuit = hand.filter(c => c.suit === lead);
  return inSuit.length > 0 ? inSuit : hand;
}

function playCard(card) {
  if (turn !== 'A' || !legalCards('A').includes(card)) return;

  hands.A.splice(hands.A.indexOf(card), 1);
  currentTrick.push({player:'A', card});
  if (currentTrick.length === 1) leadSuit = card.suit;
  if (card.suit === '♠') spadesBroken = true;

  nextTurn();
  renderGame();
}

function computerPlay() {
  if (turn === 'A' || gameOver) return;
  const player = turn;
  const legal = legalCards(player);
  let chosen = legal[0];

  if (currentTrick.length > 0) {
    const winning = findWinningCard();
    const partner = (player === 'C' || player === 'A') ? 'A' : 'B';
    const isPartnerWinning = winning.player === partner || winning.player === player;

    if (isPartnerWinning) {
      // Play lowest
      chosen = legal.reduce((a,b) => cardValue(a) < cardValue(b) ? a : b);
    } else {
      // Try to win with lowest possible
      const canWin = legal.filter(c => beats(c, winning.card));
      if (canWin.length > 0) {
        chosen = canWin.reduce((a,b) => cardValue(a) < cardValue(b) ? a : b);
      } else {
        chosen = legal.reduce((a,b) => cardValue(a) < cardValue(b) ? a : b);
      }
    }
  }

  hands[player].splice(hands[player].indexOf(chosen), 1);
  currentTrick.push({player, card:chosen});
  if (currentTrick.length === 1) leadSuit = chosen.suit;
  if (chosen.suit === '♠') spadesBroken = true;

  renderGame();

  if (currentTrick.length < 4) {
    nextTurn();
    setTimeout(computerPlay, 900);
  } else {
    setTimeout(endTrick, 1200);
  }
}

function cardValue(c) {
  return c.suit === '♠' ? 100 + c.value : c.value;
}

function beats(a, b) {
  if (a.suit === '♠' && b.suit !== '♠') return true;
  if (a.suit !== '♠' && b.suit === '♠') return false;
  if (a.suit !== b.suit) return false;
  return a.value > b.value;
}

function findWinningCard() {
  return currentTrick.reduce((win, cur) => beats(cur.card, win.card) ? cur : win);
}

function endTrick() {
  const winner = findWinningCard();
  tricksWon[winner.player]++;

  currentTrick = [];
  leadSuit = null;
  turn = winner.player;

  if (hands.A.length === 0) {
    endHand();
  } else {
    renderGame();
  }
}

function endHand() {
  handNumber++;
  const ourTricks = tricksWon.A + tricksWon.C;
  const oppTricks = tricksWon.B + tricksWon.D;
  const ourBid = bids.A + bids.C;
  const oppBid = bids.B + bids.D;

  const ourExtras = Math.max(0, ourTricks - ourBid);
  const oppExtras = Math.max(0, oppTricks - oppBid);

  teamScore.us += ourExtras;
  teamScore.them += oppExtras;

  if (teamScore.us >= 7 || teamScore.them >= 7) {
    gameOver = true;
  }

  // Reset for next hand
  bids = {A:0,B:0,C:0,D:0};
  totalBid = 0;
  currentBidder = 'A';
  tricksWon = {A:0,B:0,C:0,D:0};

  renderGame();
}

function nextTurn() {
  const idx = players.indexOf(turn);
  turn = players[(idx + 1) % 4];
}

function newGame() {
  handNumber = 0;
  teamScore = {us:0, them:0};
  gameOver = false;
  startNewHand();
}

function startNewHand() {
  deal();
  bids = {A:0,B:0,C:0,D:0};
  totalBid = 0;
  currentBidder = 'A';
  tricksWon = {A:0,B:0,C:0,D:0};
  currentTrick = [];
  spadesBroken = false;
  renderGame();
}

startNewHand();
</script>
</body>
</html>